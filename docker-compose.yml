services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: gmp_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db:5432/${POSTGRES_DB:-globemediapulse}
      - REDIS_URL=redis://redis:6379/0
      - AUTO_START_CRAWLER=0
      - CRAWLER_MODE=external
      - CRAWLER_HEARTBEAT_KEY=${CRAWLER_HEARTBEAT_KEY:-gmp:crawler:heartbeat}
      - CRAWLER_HEARTBEAT_STALE_S=${CRAWLER_HEARTBEAT_STALE_S:-45}
      - SEED_QUEUE_KEY=${SEED_QUEUE_KEY:-universal_news:start_urls}
      - SEED_SOURCE_TIERS=${SEED_SOURCE_TIERS:-Tier-0,Tier-1}
      - SEED_QUEUE_MIN=${SEED_QUEUE_MIN:-50}
      - SEED_QUEUE_TARGET=${SEED_QUEUE_TARGET:-200}
      - SEED_URL_SCHEME=${SEED_URL_SCHEME:-https}
    volumes:
      - ./data/logs:/app/logs
    labels:
      - autoheal=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/full"]
      interval: 30s
      timeout: 10s
      retries: 3

  crawler:
    build:
      context: .
      dockerfile: backend/Dockerfile.crawler
    container_name: gmp_crawler
    restart: unless-stopped
    mem_limit: 2g
    cpus: "1.5"
    depends_on:
      backend:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./data/crawler_persistence:/app/crawlers_jobdir
      - ./data/logs:/app/logs
      - ./data/output:/app/data
      - ./backend:/app/backend
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db:5432/${POSTGRES_DB:-globemediapulse}
      - REDIS_URL=redis://redis:6379/0
      - CRAWLER_HEARTBEAT_KEY=${CRAWLER_HEARTBEAT_KEY:-gmp:crawler:heartbeat}
      - CRAWLER_HEARTBEAT_STALE_S=${CRAWLER_HEARTBEAT_STALE_S:-45}
    labels:
      - autoheal=true
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import os,time,sys; import redis; url=os.getenv('REDIS_URL','').strip(); key=os.getenv('CRAWLER_HEARTBEAT_KEY','gmp:crawler:heartbeat').strip(); stale=float(os.getenv('CRAWLER_HEARTBEAT_STALE_S','45') or '45'); r=redis.from_url(url); raw=r.get(key); sys.exit(1) if raw is None else None; ts=float((raw.decode('utf-8','replace') if isinstance(raw,(bytes,bytearray)) else str(raw)).strip() or '0'); age=(time.time()-ts) if ts else 1e9; sys.exit(0) if age<=stale else sys.exit(1)"
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: postgres:15-alpine
    container_name: gmp_db
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=${POSTGRES_DB:-globemediapulse}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5433:5432"
    labels:
      - autoheal=true

  redis:
    image: redis:7-alpine
    container_name: gmp_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - autoheal=true

  frontend:
    profiles: ["dev"]
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: gmp_frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
      - "24678:24678"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8000}
      - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:8000}
      - VITE_HMR_HOST=${VITE_HMR_HOST:-localhost}
      - VITE_HMR_PORT=${VITE_HMR_PORT:-24678}
      - CHOKIDAR_USEPOLLING=${CHOKIDAR_USEPOLLING:-1}
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.svelte-kit
    labels:
      - autoheal=true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5173/"]
      interval: 30s
      timeout: 10s
      retries: 3

  autoheal:
    image: willfarrell/autoheal:1.2.0
    container_name: gmp_autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  postgres_data:
  redis_data:
